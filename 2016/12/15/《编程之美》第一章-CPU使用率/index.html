<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
       | Dreamyu&#39;s Blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Eric Yu">
    
    

    <meta name="description" content="#Mac下使用XCode实现《编程之美》第一章-CPU使用率
##实现过程
###实现50%占用率

看完1.1节后直接撸代码，V0.1版本：12345while (1) &amp;#123;    for (int k = 0; k &amp;lt; 9600000; k++) &amp;#123;&amp;#125;    //usleep()参数为微秒(us)    usleep(10000);&amp;#125;
&amp;emsp;&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content=" | Dreamyu's Blog">
<meta property="og:url" content="http://yoursite.com/2016/12/15/《编程之美》第一章-CPU使用率/index.html">
<meta property="og:site_name" content="Dreamyu's Blog">
<meta property="og:description" content="#Mac下使用XCode实现《编程之美》第一章-CPU使用率
##实现过程
###实现50%占用率

看完1.1节后直接撸代码，V0.1版本：12345while (1) &amp;#123;    for (int k = 0; k &amp;lt; 9600000; k++) &amp;#123;&amp;#125;    //usleep()参数为微秒(us)    usleep(10000);&amp;#125;
&amp;emsp;&amp;">
<meta property="og:image" content="http://oi9lc0fjo.bkt.clouddn.com/image/beautiful-code/CPUManager/CPUManagerDebug_1.png">
<meta property="og:image" content="http://oi9lc0fjo.bkt.clouddn.com/image/beautiful-code/CPUManager/CPUManagerDebug_2.png">
<meta property="og:updated_time" content="2016-12-21T08:43:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" | Dreamyu's Blog">
<meta name="twitter:description" content="#Mac下使用XCode实现《编程之美》第一章-CPU使用率
##实现过程
###实现50%占用率

看完1.1节后直接撸代码，V0.1版本：12345while (1) &amp;#123;    for (int k = 0; k &amp;lt; 9600000; k++) &amp;#123;&amp;#125;    //usleep()参数为微秒(us)    usleep(10000);&amp;#125;
&amp;emsp;&amp;">
<meta name="twitter:image" content="http://oi9lc0fjo.bkt.clouddn.com/image/beautiful-code/CPUManager/CPUManagerDebug_1.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Dreamyu&#39;s Blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          知行合一
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title"></h1>

    

    <div class="post-meta">
      <time datetime="2016-12-15" class="post-meta__date date">2016-12-15</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>#Mac下使用XCode实现《编程之美》第一章-CPU使用率</p>
<p>##实现过程</p>
<p>###实现50%占用率</p>
<hr>
<p>看完1.1节后直接撸代码，V0.1版本：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">9600000</span>; k++) &#123;&#125;</div><div class="line">    <span class="comment">//usleep()参数为微秒(us)</span></div><div class="line">    usleep(<span class="number">10000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这段代码很简单，原理书上都有，但是有一个问题就是怎么放在理想环境下测试，不然很难验证程序的效果，我尝试使用系统自带的活动监视器来监视CPU曲线，结果发现 so stupid ，完全不是那回事儿。但是在打断点进入汇编代码的过程中，我发现XCode的Debug工具自带CPU使用分析程序……。打开面板以后发现，窝草，简直完美！生活中不缺少美，而是缺少一双发现美的眼睛(ಥ<em>ಥ)</em>)。</p><br><img src="http://oi9lc0fjo.bkt.clouddn.com/image/beautiful-code/CPUManager/CPUManagerDebug_1.png" alt="图片被吞了" title="第一次运行结果"><br><p>&emsp;&emsp;打开Xcode的调试面板我们就会惊喜的发现CPU使用稳定在了……66%，这TM就有点尴尬了，不过这至少证明该方法是可行而且成功了的。下面就是纠正了，这个很简单，使用率 <code>66% = busytime/busytime+idletime</code> ,可以得知 <code>busytime = 2 * idletime</code> ,所以将 for 循环中的 9600000 改为 4800000 即可。</p><br><p>&emsp;&emsp;但是很显然只是这样做是不够的，我们需要知道为什么第一次的运行结果是 66% 。书中是如何得出 9600000 这个数字的呢，因为 CPU 为 <code>2.4Ghz</code> ，而书中的空循环代码在转为汇编代码后为 <code>5</code> 条指令，而 CPU 每个时钟周期可以执行两条指令，所以一秒内可以循环 <code>（2400000000*2)/5 = 960000000</code> 次, 10 毫秒对应就是 9600000 。首先想到的问题就是 CPU 频率，这点可以很方便的从本机信息中知道，我的机器是 <code>2.7 GHz Intel Core i5</code> ，但是很显然这样做得出的循环次数比原来还要多，所以问题应该是汇编指令条数应该多于5条。然而像我这种汇编挂到大四的超级学渣很显然不可能根据 C 代码去反推汇编过程，所幸 XCode 的断点调试支持汇编 Debug (菜单栏 Product -&gt; Debug Wokflow ，Show disassembly When Debugging 选项，打钩即可)。我们在空循环内打个断点，可以看到汇编代码如下:</p><br><img src="http://oi9lc0fjo.bkt.clouddn.com/image/beautiful-code/CPUManager/CPUManagerDebug_2.png" alt="" title="汇编代码"><br><p>&emsp;&emsp;在 Google 的帮助下我们可以知道第 7 行是循环的开始——为 i 赋值，而结束就比较明显了——17 行调用了 usleep()，可以得出空循环执行了 <code>11</code> 条汇编指令,所以在一个周期中， busyloop 应该执行 <code>(27000000*2)/11 = 4909090</code>次，与调整后的循环次数 4800000 基本一致！撒花ヾ(^▽^ヾ)</p><br>###动态调节忙/闲时间比<br><em>**<br><p>&emsp;&emsp;思路就是在空循环中获取当前时间与起始时间对比，这样就可以直观的限定循环运行时间<del>(所以说上面搞了这么久就是在瞎折腾)</del>。与 Windows 不同的就是 Linux 系统的系统获取时间函数是 <code>gettimeofday</code>。这里要注意的就是返回值是一个结构体，其中秒数 tv_sec 与 微秒 tv_usec 是分开的，程序中以微秒为单位，所以当前时间应表示为 `tv.tv_sec </p></em> 1000000 + tv.tv_usec<code>。代码如下:&lt;/p&gt;
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">long</span> endTime = tv.tv_sec * <span class="number">1000000</span> + tv.tv_usec;</div><div class="line">    <span class="keyword">long</span> startTime = endTime;</div><div class="line">    <span class="keyword">while</span> (endTime - startTime &lt;= busy_time) &#123;</div><div class="line">        gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">        endTime = tv.tv_sec * <span class="number">1000000</span> + tv.tv_usec;</div><div class="line">    &#125;</div><div class="line">    usleep(idle_time*<span class="number">0.82</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>

&lt;p&gt;&amp;emsp;&amp;emsp;这里执行后会发现使用率并没有稳定在 50% ，而是 45% ,具体原因并不知道……。所以我给 idletime 乘了一个 0.82 的系数。&lt;/p&gt;
###正弦函数
&lt;p&gt;&amp;emsp;&amp;emsp;基本思路是调整每次循环的忙/闲时间比，使其符合正弦曲线。其实原理就跟初中时刚学函数一样，把函数理解为连续的点或者说线段连接起来就行了，只要点-即“时间片”足够小，表现出来就是曲线。经过几次调试，我把时间片定在0.1秒，数量为300个，这样在XCode上的显示效果比较好😁。&lt;/p&gt;
&lt;p&gt;&amp;emsp;&amp;emsp;最终为了方便调试我把直线和正弦合并了，其实理论应该可以写成一个画出任意二元函数曲线的程序，代码如下:&lt;/p&gt;
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">struct</span> timeval tv;</div><div class="line">    <span class="keyword">int</span> count = <span class="number">300</span>;</div><div class="line">    <span class="keyword">char</span> type[<span class="number">20</span>];</div><div class="line">    <span class="keyword">double</span> busy_time[count];</div><div class="line">    <span class="keyword">double</span> idle_time[count];</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>,type);</div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(type, <span class="string">"triggle"</span>)) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            busy_time[i] = <span class="number">100000</span>*(<span class="built_in">sin</span>(i*M_PI*<span class="number">2</span>/count)+<span class="number">1</span>)*<span class="number">0.5</span>;</div><div class="line">            idle_time[i] = <span class="number">100000</span> - busy_time[i];</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            busy_time[i] = <span class="number">50000</span>;</div><div class="line">            idle_time[i] = <span class="number">100000</span> - busy_time[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">        <span class="keyword">long</span> endTime = tv.tv_sec * <span class="number">1000000</span> + tv.tv_usec;</div><div class="line">        <span class="keyword">long</span> startTime = endTime;</div><div class="line">        <span class="keyword">while</span> (endTime - startTime &lt;= busy_time[j]) &#123;</div><div class="line">            gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">            endTime = tv.tv_sec * <span class="number">1000000</span> + tv.tv_usec;</div><div class="line">        &#125;</div><div class="line">        usleep(idle_time[j]*<span class="number">0.82</span>);</div><div class="line">        j = (j+<span class="number">1</span>)%count;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

&lt;p&gt;&amp;emsp;&amp;emsp; command+R 后我们就可以欣赏到 CPU 使用率画出优美的正弦曲线了，虽然不是很齐😂，但是还是很激动哒！&lt;/p&gt;
![](http://oi9lc0fjo.bkt.clouddn.com/image/beautiful-code/CPUManager/CPUManagerDebug_3.png &quot;美丽的正弦曲线&quot;)
####Tips
1. 系统sin()(或者说所有Trigger函数)参数为弧度制，所以参数应乘以PI(xcode中可使用M_PI)。
2. 在分开计算正弦函数分布的时间片时，</code>(i/count<em>M_PI</em>2)<code>会导致结果一直为零，纠结了很久，结果发现把 count 放到后面就行了</code>(i<em>M_PI</em>2/count)` ,原因是 i 与 count 都是 int 类型，直接除会直接导致取整为 0 ，感觉自己还是 naive ，毕竟 C 当初都是混过去的。。。<br><br>最后附上 Github 地址:<a href="https://github.com/Feave/Beautiful-Code/tree/master/CPUManager" target="_blank" rel="external">《编程之美》第一章-CPU使用率</a><br><br>##总结<br><p>&emsp;&emsp;刚开始看这一章的题目时候我还觉得很神奇，还可以控制 CPU 使用率画正弦曲线？但其实问题很简单就解决。当经过一番努力，最后看到那条曲线的时候，感觉突然就有点理解“编程之美”了。</p><br><p>&emsp;&emsp;其实第一章的程序只要看过一遍书很简单，但是架不住基础太差，现在回想起来当初上的 C 语言，汇编，算法导论，数据结构，编译原理都是神课，然而这些课全被我逃了过去。人啊，总是失去的才懂得珍惜😂。</p>

<p>##第一章的闲言碎语</p>
<p>&emsp;&emsp;七个月前，因为要找实习我买了《编程之美这本书》，但其实并没有仔细看下去。自从来到深圳以后，平时学习的主要方式就是阅读 RSS 了，但是其实这样做更多的是一种心理安慰，这种碎片化的学习对我这种完全没有形成知识系统的人来说基本没什么卵用，最后能记住都是一些工具化的东西，而且营造了一种安慰感——“我在学”。但其实对于不想变得庸庸碌碌的人来说，自我欺骗是最可怕的。如何不成为一名“码农”，先定个小目标吧——看完《编程之美》。</p>
  </section>

  
  
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
